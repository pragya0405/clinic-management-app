<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinic Management App</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
      min-height: 100vh;
      margin: 0; padding: 0;
    }
    .container {
      background: #fff;
      max-width: 950px;
      margin: 32px auto;
      box-shadow: 0 6px 32px rgb(0 0 0 / 0.13);
      border-radius: 18px;
      padding: 28px 36px;
    }
    h1 { text-align: center; color: #364f6b; }
    h2 { color: #3b6978; margin-bottom: 15px; }
    section { margin-bottom: 35px; }
    .flex-row { display: flex; align-items: center; gap: 22px; flex-wrap: wrap; }
    .stats { justify-content: space-around; background: #feeeef; padding: 16px; border-radius: 10px; margin-bottom: 36px; }
    .stat-box { text-align: center; }
    .stat-num { font-size: 2.5rem; color: #f4976c; font-weight: bold; }
    .stat-label { color: #364f6b; font-size: 1rem; }
    input, select, button {
      padding: 8px; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc;
      margin-right: 10px;
    }
    button, .btn {
      background: #fc5185; color: white; border: none; cursor: pointer; font-weight: bold;
      padding: 8px 13px; border-radius: 5px; transition: background 0.1s;
      text-decoration: none;
    }
    button:hover, .btn:hover {
      background: #364f6b;
    }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px;}
    th, td { padding: 9px 12px; text-align: left; }
    th { background: #f4976c; color: #fff; }
    tr:nth-child(even) { background: #fcf6f5; }
    tr:hover { background: #f7d9c4; }
    .fa-edit, .fa-trash { cursor: pointer; }
    .fa-edit { color: #17b978; }
    .fa-trash { color: #fc5185; margin-left: 7px; }
    .message { padding: 8px 14px; margin: 12px 0; border-radius: 7px; }
    .success { background: #caffd3; color: #1e5631; }
    .error { background: #ffdde0; color: #e94560; }
    @media (max-width:650px) {
      .container { padding: 20px 5px; }
      .stats { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1><i class="fa-solid fa-hospital"></i> Clinic Management App</h1>

  <!-- Stats -->
  <div class="flex-row stats" id="statsRow"></div>

  <!-- Doctors -->
  <section>
    <div class="flex-row">
      <h2><i class="fa-user-md"></i> Doctors</h2>
      <input id="searchDoctor" type="text" placeholder="Search doctors..." style="margin-bottom:6px;">
      <button onclick="loadDoctors()">Reload List</button>
    </div>
    <div class="table-wrap">
      <table id="doctorsTable"></table>
    </div>
  </section>

  <!-- Patients -->
  <section>
    <div class="flex-row">
      <h2><i class="fa-solid fa-users-medical"></i> Patients</h2>
      <input id="searchPatient" type="text" placeholder="Search patients...">
      <button onclick="loadPatients()">Reload List</button>
    </div>
    <div class="table-wrap">
      <table id="patientsTable"></table>
    </div>
    <h3>Add Patient</h3>
    <form id="patientForm" class="flex-row" style="flex-wrap: wrap;">
      <input type="text" id="patientName" placeholder="Name" required />
      <input type="text" id="patientPhone" placeholder="Phone" required />
      <button type="submit"><i class="fa fa-user-plus"></i> Add</button>
    </form>
    <div id="patientMessage"></div>
  </section>

  <!-- Book Appointment -->
  <section>
    <h2><i class="fa-regular fa-calendar-plus"></i> Book Appointment</h2>
    <form id="appointmentForm" class="flex-row" style="flex-wrap:wrap;">
      <select id="selectPatient" required>
        <option value="">Select Patient</option>
      </select>
      <select id="selectDoctor" required>
        <option value="">Select Doctor</option>
      </select>
      <input type="datetime-local" id="appointmentDate" required>
      <button type="submit"><i class="fa fa-calendar-plus"></i> Book</button>
    </form>
    <div id="appointmentMessage"></div>
  </section>

  <!-- Appointments -->
  <section>
    <div class="flex-row">
      <h2><i class="fa-solid fa-calendar-days"></i> Appointments</h2>
      <input id="searchAppointment" type="text" placeholder="Search appointments...">
      <button onclick="loadAppointments()">Reload List</button>
    </div>
    <div class="table-wrap">
      <table id="appointmentsTable"></table>
    </div>
  </section>
</div>
<script>
  // --- Utility ---
  const showMsg = (id, msg, cls) => {
    let div = document.getElementById(id);
    div.textContent = msg;
    div.className = 'message ' + cls;
    setTimeout(()=>div.textContent='',3000);
  };
  // --- Stats ---
  function updateStats(doctors,patients,appointments){
    document.getElementById('statsRow').innerHTML = `
      <div class="stat-box"><div class="stat-num">${doctors.length}</div><div class="stat-label">Doctors</div></div>
      <div class="stat-box"><div class="stat-num">${patients.length}</div><div class="stat-label">Patients</div></div>
      <div class="stat-box"><div class="stat-num">${appointments.length}</div><div class="stat-label">Appointments</div></div>
    `;
  }
  // --- Doctors ---
  let doctorsCache=[];
  function loadDoctors(){
    fetch('http://localhost:3000/doctors').then(res=>res.json()).then(data=>{
      doctorsCache=data;
      let q = document.getElementById('searchDoctor').value.trim().toLowerCase();
      let view = q? data.filter(d=>d.name.toLowerCase().includes(q)||d.specialty.toLowerCase().includes(q)) : data;
      let rows='<tr><th>Name</th><th>Specialty</th></tr>';
      view.forEach(d=>{
        rows+=`<tr><td>${d.name}</td><td>${d.specialty}</td></tr>`;
      });
      document.getElementById('doctorsTable').innerHTML=rows;
      // For Appointment select
      let sel=document.getElementById('selectDoctor');
      sel.innerHTML='<option value="">Select Doctor</option>';
      data.forEach(doc=>{
        sel.innerHTML+=`<option value="${doc.id}">${doc.name} (${doc.specialty})</option>`;
      });
      updateStats(doctorsCache,patientsCache,appointmentsCache);
    }).catch(()=>{
      document.getElementById('doctorsTable').innerHTML='<tr><td colspan="2">Failed to load doctors.</td></tr>';
    });
  }
  document.getElementById('searchDoctor').addEventListener('input',loadDoctors);

  // --- Patients ---
  let patientsCache=[];
  function loadPatients(){
    fetch('http://localhost:3000/patients').then(res=>res.json()).then(data=>{
      patientsCache=data;
      let q = document.getElementById('searchPatient').value.trim().toLowerCase();
      let view = q? data.filter(p=>p.name.toLowerCase().includes(q)||p.phone.includes(q)) : data;
      let rows='<tr><th>Name</th><th>Phone</th><th>Edit</th><th>Delete</th></tr>';
      view.forEach(p=>{
        rows+=`<tr>
          <td>${p.name}</td>
          <td>${p.phone}</td>
          <td><i class="fas fa-edit" onclick="editPatient(${p.id})"></i></td>
          <td><i class="fas fa-trash" onclick="deletePatient(${p.id})"></i></td>
        </tr>`;
      });
      if(view.length === 0) {
        rows = '<tr><td colspan="4">No patients found.</td></tr>';
      }
      document.getElementById('patientsTable').innerHTML=rows;
      // For Appointment select
      let sel=document.getElementById('selectPatient');
      sel.innerHTML='<option value="">Select Patient</option>';
      data.forEach(pt=>{
        sel.innerHTML+=`<option value="${pt.id}">${pt.name} (${pt.phone})</option>`;
      });
      updateStats(doctorsCache,patientsCache,appointmentsCache);
    }).catch(()=>{
      document.getElementById('patientsTable').innerHTML='<tr><td colspan="4">Failed to load patients.</td></tr>';
    });
  }
  document.getElementById('searchPatient').addEventListener('input',loadPatients);

  // Add Patient
  document.getElementById('patientForm').addEventListener('submit',function(e){
    e.preventDefault();
    let name=document.getElementById('patientName').value.trim();
    let phone=document.getElementById('patientPhone').value.trim();
    fetch('http://localhost:3000/patients',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name,phone})
    }).then(res=>res.json()).then(data=>{
      if(data.error) showMsg('patientMessage',data.error,'error');
      else{
        showMsg('patientMessage','Patient added!','success');
        this.reset();
        loadPatients();
      }
    }).catch(()=>{
      showMsg('patientMessage','Failed to add patient.','error');
    });
  });

  // --- Edit Patient Modal/Prompt ---
  window.editPatient = function(id){
    let pt = patientsCache.find(p=>p.id===id);
    let name = prompt("Edit patient name:",pt.name);
    if(name===null) return;
    name = name.trim();
    let phone = prompt("Edit patient phone:",pt.phone);
    if(phone===null) return;
    phone = phone.trim();
    fetch('http://localhost:3000/patients/'+id,{
      method:'PUT', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name,phone})
    }).then(res=>res.json()).then(data=>{
      if(data.error) showMsg('patientMessage',data.error,'error');
      else{
        showMsg('patientMessage','Patient updated!','success');
        loadPatients();
      }
    }).catch(() => {
      showMsg('patientMessage','Failed to update patient.','error');
    });
  };
  // --- Delete Patient ---
  window.deletePatient = function(id){
    if(!confirm("Are you sure you want to delete this patient?")) return;
    fetch('http://localhost:3000/patients/'+id,{method:'DELETE'})
      .then(res=>res.json())
      .then(data=>{
        if(data.error) showMsg('patientMessage',data.error,'error');
        else{
          showMsg('patientMessage','Patient deleted!','success');
          loadPatients();
          loadAppointments();  // Refresh appointments as well to remove any linked to deleted patient
        }
      }).catch(() => {
        showMsg('patientMessage','Failed to delete patient.','error');
      });
  };

  // --- Appointments ---
  let appointmentsCache=[];
  function loadAppointments(){
    fetch('http://localhost:3000/appointments').then(res=>res.json()).then(data=>{
      appointmentsCache=data;
      let q=document.getElementById('searchAppointment').value.trim().toLowerCase();
      let view=q ?
        data.filter(a=>a.patientName.toLowerCase().includes(q)||a.doctorName.toLowerCase().includes(q)) : data;
      let rows='<tr><th>Patient</th><th>Doctor</th><th>Date/Time</th><th>Delete</th></tr>';
      view.forEach(a=>{
        let dt = new Date(a.date);
        rows+=`<tr>
          <td>${a.patientName}</td>
          <td>${a.doctorName}</td>
          <td>${dt.toLocaleString()}</td>
          <td><i class="fas fa-trash" onclick="deleteAppointment(${a.id})"></i></td>
        </tr>`;
      });
      if(view.length === 0) {
        rows = '<tr><td colspan="4">No appointments found.</td></tr>';
      }
      document.getElementById('appointmentsTable').innerHTML=rows;
      updateStats(doctorsCache,patientsCache,appointmentsCache);
    }).catch(()=>{
      document.getElementById('appointmentsTable').innerHTML='<tr><td colspan="4">Failed to load appointments.</td></tr>';
    });
  }
  document.getElementById('searchAppointment').addEventListener('input',loadAppointments);

  // Book appointment
  document.getElementById('appointmentForm').addEventListener('submit',function(e){
    e.preventDefault();
    let patientId=parseInt(document.getElementById('selectPatient').value);
    let doctorId=parseInt(document.getElementById('selectDoctor').value);
    let date=document.getElementById('appointmentDate').value;
    if(!patientId||!doctorId||!date) {
      showMsg('appointmentMessage','Select patient, doctor, date','error');
      return;
    }
    // Conflict check (prevent double-booked doctor or patient)
    if(appointmentsCache.some(a=>
      (a.doctorId===doctorId && a.date===date) || (a.patientId===patientId && a.date===date)
    )) {
      showMsg('appointmentMessage','Conflict detected: Doctor or patient already has appointment at this time.','error');
      return;
    }
    fetch('http://localhost:3000/appointments',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({patientId,doctorId,date})
    }).then(res=>res.json()).then(data=>{
      if(data.error) showMsg('appointmentMessage',data.error,'error');
      else{
        showMsg('appointmentMessage','Appointment booked!','success');
        this.reset();
        loadAppointments();
      }
    }).catch(()=>{
      showMsg('appointmentMessage','Failed to book appointment.','error');
    });
  });

  // --- Delete Appointment ---
  window.deleteAppointment=function(id){
    if(!confirm("Delete this appointment?")) return;
    fetch('http://localhost:3000/appointments/'+id,{method:'DELETE'})
      .then(res=>res.json())
      .then(data=>{
        if(data.error) showMsg('appointmentMessage',data.error,'error');
        else {
          showMsg('appointmentMessage','Appointment deleted!','success');
          loadAppointments();
        }
      }).catch(() => {
        showMsg('appointmentMessage','Failed to delete appointment.','error');
      });
  };

  // --- Onload load all ---
  window.onload = () => {
    loadDoctors();
    loadPatients();
    loadAppointments();
  };
</script>
</body>
</html>
